// Generated by CoffeeScript 1.10.0
(function() {
  var HAProxyService, StormService, fs, merge,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  StormService = require('stormservice');

  merge = require('fmerge');

  fs = require('fs');

  HAProxyService = (function(superClass) {
    extend(HAProxyService, superClass);

    HAProxyService.prototype.invocation = {
      name: 'haproxy',
      path: '/usr/sbin',
      monitor: true,
      args: [],
      options: {
        detached: true,
        stdio: ["ignore", -1, -1]
      }
    };

    function HAProxyService(id, data, opts) {
      if (data.instance != null) {
        this.instance = data.instance;
        delete data.instance;
      }
      if (opts == null) {
        opts = {};
      }
      if (opts.configPath == null) {
        opts.configPath = "/var/stormflash/plugins/haproxy";
      }
      if (opts.logPath == null) {
        opts.logPath = "/var/log/haproxy";
      }
      HAProxyService.__super__.constructor.call(this, id, data, opts);
      this.configs = {
        service: {
          filename: this.configPath + "/" + this.id + ".conf"
        }
      };
      this.invocation = merge(this.invocation, {
        args: ["-d", "-f", "" + this.configs.service.filename],
        options: {
          stdio: ["ignore", this.out, this.err]
        }
      });
      this.configs.service.generator = (function(_this) {
        return function(callback) {
          var backend, frontend, haproxyconfig, i, ival, j, jkey, jval, k, key, keyy, kkey, kval, l, len, len1, len10, len11, len12, len13, len2, len3, len4, len5, len6, len7, len8, len9, m, myarray, n, o, p, peers, q, r, ref, s, t, u, userlist, v, val, value;
          haproxyconfig = "";
          ref = _this.data;
          for (key in ref) {
            val = ref[key];
            switch (key) {
              case "global":
              case "defaults":
                haproxyconfig += key + "\n";
                for (keyy in val) {
                  value = val[keyy];
                  switch (typeof value) {
                    case "string":
                    case "number":
                      haproxyconfig += '    ' + keyy + ' ' + value + '\n';
                  }
                  if (value instanceof Array) {
                    myarray = "yes";
                    for (i = 0, len = value.length; i < len; i++) {
                      ival = value[i];
                      if (ival instanceof Array) {
                        haproxyconfig += '    ' + keyy;
                        for (j = 0, len1 = ival.length; j < len1; j++) {
                          jval = ival[j];
                          haproxyconfig += ' ' + jval;
                        }
                        haproxyconfig += '\n';
                      }
                      if (!(ival instanceof Array)) {
                        switch (typeof ival) {
                          case "string":
                          case "number":
                            if (myarray === "yes") {
                              haproxyconfig += '    ' + keyy + ' ' + ival;
                            }
                            if (myarray !== "yes") {
                              haproxyconfig += ' ' + ival;
                            }
                            myarray = "no";
                            break;
                          case "object":
                            haproxyconfig += '    ' + keyy;
                            for (kkey in ival) {
                              kval = ival[kkey];
                              haproxyconfig += ' ' + kkey + ' ' + kval;
                            }
                            haproxyconfig += '\n';
                        }
                      }
                    }
                    haproxyconfig += '\n';
                  }
                }
                haproxyconfig += '\n';
                break;
              case "frontend":
                for (k = 0, len2 = val.length; k < len2; k++) {
                  frontend = val[k];
                  for (keyy in frontend) {
                    value = frontend[keyy];
                    switch (typeof value) {
                      case "string":
                      case "number":
                        if (keyy === "name") {
                          haproxyconfig += key + ' ' + value + '\n';
                        }
                        if (keyy !== "name") {
                          haproxyconfig += '    ' + keyy + ' ' + value + '\n';
                        }
                        break;
                      case "object":
                        haproxyconfig += "\n";
                    }
                    if (value instanceof Array) {
                      myarray = "yes";
                      for (l = 0, len3 = value.length; l < len3; l++) {
                        ival = value[l];
                        if (!(ival instanceof Array)) {
                          switch (typeof ival) {
                            case "string":
                            case "number":
                              if (myarray === "yes") {
                                haproxyconfig += '    ' + keyy + ' ' + ival;
                              }
                              if (myarray !== "yes") {
                                haproxyconfig += ' ' + ival;
                              }
                              myarray = "no";
                              break;
                            case "object":
                              if (keyy !== "bind") {
                                if (keyy !== "use_backend") {
                                  haproxyconfig += '    ' + keyy;
                                  for (kkey in ival) {
                                    kval = ival[kkey];
                                    haproxyconfig += ' ' + kkey + ' ' + kval;
                                  }
                                  haproxyconfig += '\n';
                                }
                              } else {
                                haproxyconfig += '\n';
                              }
                          }
                        }
                        if (ival instanceof Array) {
                          haproxyconfig += "    " + keyy;
                          for (m = 0, len4 = ival.length; m < len4; m++) {
                            kval = ival[m];
                            haproxyconfig += " " + kval;
                          }
                          haproxyconfig += "\n";
                        }
                        if (keyy === "bind") {
                          haproxyconfig += "    " + keyy;
                          for (jkey in ival) {
                            jval = ival[jkey];
                            switch (jkey) {
                              case "servername":
                                haproxyconfig += " " + jval;
                                break;
                              case "port":
                                haproxyconfig += ":" + jval;
                                break;
                              case "options":
                                haproxyconfig += " " + jval;
                            }
                          }
                          haproxyconfig += "\n";
                        }
                        if (keyy === "use_backend") {
                          for (jkey in ival) {
                            jval = ival[jkey];
                            for (n = 0, len5 = jval.length; n < len5; n++) {
                              kval = jval[n];
                              haproxyconfig += "    " + keyy + " " + jkey + " " + kval + "\n";
                            }
                          }
                        }
                        if (key === "listen") {
                          if (keyy === "server") {
                            haproxyconfig += "    " + keyy;
                            for (jkey in ival) {
                              jval = ival[jkey];
                              switch (jkey) {
                                case "servername":
                                  haproxyconfig += " " + jval;
                                  break;
                                case "serverIP":
                                  haproxyconfig += " " + jval;
                                  break;
                                case "port":
                                  haproxyconfig += ":" + jval;
                                  break;
                                default:
                                  haproxyconfig += " " + jkey + " " + jval;
                              }
                            }
                            haproxyconfig += "\n";
                          }
                        }
                      }
                      haproxyconfig += "\n";
                    }
                  }
                  haproxyconfig += "\n";
                }
                haproxyconfig += '\n';
                break;
              case "backend":
              case "listen":
                for (o = 0, len6 = val.length; o < len6; o++) {
                  backend = val[o];
                  for (keyy in backend) {
                    value = backend[keyy];
                    switch (typeof value) {
                      case "string":
                      case "number":
                        if (keyy === "name") {
                          haproxyconfig += key + ' ' + value + '\n';
                        }
                        if (keyy !== "name") {
                          haproxyconfig += '    ' + keyy + ' ' + value + '\n';
                        }
                        break;
                      case "object":
                        haproxyconfig += "\n";
                    }
                    if (value instanceof Array) {
                      myarray = "yes";
                      for (p = 0, len7 = value.length; p < len7; p++) {
                        ival = value[p];
                        if (ival instanceof Array) {
                          haproxyconfig += "    " + keyy;
                          for (q = 0, len8 = ival.length; q < len8; q++) {
                            jval = ival[q];
                            haproxyconfig += " " + jval;
                          }
                          haproxyconfig += "\n";
                        }
                        if (keyy === "server") {
                          haproxyconfig += "    " + keyy;
                          for (jkey in ival) {
                            jval = ival[jkey];
                            switch (jkey) {
                              case "servername":
                                haproxyconfig += " " + jval;
                                break;
                              case "serverIP":
                                haproxyconfig += " " + jval;
                                break;
                              case "port":
                                haproxyconfig += ":" + jval;
                                break;
                              default:
                                haproxyconfig += " " + jkey + " " + jval;
                            }
                          }
                          haproxyconfig += "\n";
                        }
                        if (key === "listen") {
                          if (keyy === "bind") {
                            haproxyconfig += "    " + keyy;
                            for (jkey in ival) {
                              jval = ival[jkey];
                              switch (jkey) {
                                case "servername":
                                  haproxyconfig += " " + jval;
                                  break;
                                case "port":
                                  haproxyconfig += ":" + jval;
                                  break;
                                default:
                                  haproxyconfig += " " + jval;
                              }
                            }
                            haproxyconfig += "\n";
                          }
                        }
                        if (!(ival instanceof Array)) {
                          switch (typeof ival) {
                            case "string":
                            case "number":
                              if (myarray === "yes") {
                                haproxyconfig += '    ' + keyy + ' ' + ival;
                              }
                              if (myarray !== "yes") {
                                haproxyconfig += ' ' + ival;
                              }
                              myarray = "no";
                              break;
                            case "object":
                              if (keyy !== "bind") {
                                if (keyy !== "server") {
                                  haproxyconfig += '    ' + keyy;
                                  for (kkey in ival) {
                                    kval = ival[kkey];
                                    haproxyconfig += ' ' + kkey + ' ' + kval;
                                  }
                                  haproxyconfig += '\n';
                                }
                              } else {
                                haproxyconfig += '\n';
                              }
                          }
                        }
                      }
                      haproxyconfig += "\n";
                    }
                  }
                }
                haproxyconfig += "\n\n";
                break;
              case "peers":
              case "mailers":
                for (r = 0, len9 = val.length; r < len9; r++) {
                  peers = val[r];
                  for (keyy in peers) {
                    value = peers[keyy];
                    switch (typeof value) {
                      case "string":
                      case "number":
                        if (keyy === "name") {
                          haproxyconfig += key + ' ' + value + '\n';
                        }
                        if (keyy !== "name") {
                          haproxyconfig += ' ' + keyy + ' ' + value + '\n';
                        }
                        break;
                      case "object":
                        haproxyconfig += "\n";
                    }
                    if (value instanceof Array) {
                      if (keyy === "peer" || "mailer") {
                        for (s = 0, len10 = value.length; s < len10; s++) {
                          ival = value[s];
                          haproxyconfig += "    " + keyy;
                          for (jkey in ival) {
                            jval = ival[jkey];
                            switch (jkey) {
                              case "servername":
                                haproxyconfig += " " + jval;
                                break;
                              case "serverIP":
                                haproxyconfig += " " + jval;
                                break;
                              case "port":
                                haproxyconfig += ":" + jval;
                                break;
                              default:
                                haproxyconfig += " " + jkey + " " + jval;
                            }
                          }
                          haproxyconfig += "\n";
                        }
                        haproxyconfig += "\n";
                      }
                    }
                  }
                }
                break;
              case "userlist":
                for (t = 0, len11 = val.length; t < len11; t++) {
                  userlist = val[t];
                  for (keyy in userlist) {
                    value = userlist[keyy];
                    switch (typeof value) {
                      case "string":
                      case "number":
                        if (keyy === "name") {
                          haproxyconfig += 'userlist' + ' ' + value + '\n';
                        }
                        if (keyy !== "name") {
                          haproxyconfig += ' ' + keyy + ' ' + value + '\n';
                        }
                        break;
                      case "object":
                        haproxyconfig += "\n";
                    }
                    if (value instanceof Array) {
                      if (keyy === "user" || "group") {
                        for (u = 0, len12 = value.length; u < len12; u++) {
                          ival = value[u];
                          haproxyconfig += "    " + keyy;
                          for (v = 0, len13 = ival.length; v < len13; v++) {
                            kval = ival[v];
                            haproxyconfig += " " + kval;
                          }
                          haproxyconfig += "\n";
                        }
                        haproxyconfig += "\n";
                      }
                    }
                  }
                  haproxyconfig += "\n";
                }
                haproxyconfig += "\n";
                break;
              default:
                haproxyconfig += "\n";
            }
          }
          return callback(haproxyconfig);
        };
      })(this);
    }

    HAProxyService.prototype.update = function(newconfig, callback) {
      this.data = newconfig;
      return this.generate(callback);
    };

    HAProxyService.prototype.destructor = function() {
      this.eliminate();
      return this.emit('destroy');
    };

    return HAProxyService;

  })(StormService);

  module.exports = HAProxyService;

}).call(this);
